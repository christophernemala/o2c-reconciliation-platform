<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DHCM AR Reconciliation - FIXED</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#0f172a;color:#f8fafc;padding:2rem}
.container{max-width:1600px;margin:0 auto}
.header{background:#1e293b;padding:2rem;border-radius:12px;margin-bottom:2rem;border:2px solid #3b82f6}
.header h1{font-size:2rem;color:#3b82f6;margin-bottom:0.5rem}
.section{background:#1e293b;padding:2rem;border-radius:12px;margin-bottom:2rem;border:1px solid #334155}
.section-title{font-size:1.5rem;margin-bottom:1.5rem;color:#60a5fa}
.upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem}
.upload-box{border:2px dashed #3b82f6;padding:2rem;border-radius:12px;text-align:center;cursor:pointer;transition:all 0.3s}
.upload-box:hover{border-color:#60a5fa;background:rgba(59,130,246,0.1)}
.upload-box.uploaded{border-color:#10b981;background:rgba(16,185,129,0.1)}
.file-input{display:none}
.upload-label{cursor:pointer;display:block}
.upload-icon{width:60px;height:60px;margin:0 auto 1rem;stroke:#3b82f6}
.upload-title{font-size:1.2rem;margin-bottom:0.5rem;font-weight:700}
.file-name{background:#10b981;color:white;padding:0.5rem 1rem;border-radius:6px;margin-top:1rem;display:none}
.upload-box.uploaded .file-name{display:inline-block}
.preview{background:#0f172a;border:1px solid #334155;border-radius:8px;margin-top:1rem;padding:1rem;max-height:300px;overflow-y:auto;display:none;text-align:left}
.upload-box.uploaded .preview{display:block}
.preview h4{color:#10b981;margin-bottom:1rem;font-size:1rem}
.preview-item{padding:0.5rem;border-bottom:1px solid #334155;font-size:0.9rem}
.preview-item:last-child{border-bottom:none}
.preview-label{color:#94a3b8;display:inline-block;width:200px}
.preview-value{color:#f8fafc;font-weight:600}
.btn{padding:1rem 2rem;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:1rem;transition:all 0.3s}
.btn-primary{background:#3b82f6;color:white}
.btn-primary:hover{background:#2563eb;transform:translateY(-2px)}
.btn-success{background:#10b981;color:white}
.btn-secondary{background:#334155;color:#f8fafc;border:2px solid #3b82f6}
.hidden{display:none!important}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;margin-bottom:2rem}
.stat-card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:1.5rem}
.stat-value{font-size:2.5rem;font-weight:800;color:#3b82f6;margin-bottom:0.5rem}
.stat-label{color:#94a3b8;font-size:0.9rem}
.tabs{display:flex;gap:0.5rem;margin-bottom:2rem;border-bottom:2px solid #334155}
.tab{padding:1rem 2rem;background:transparent;border:none;color:#94a3b8;font-weight:600;cursor:pointer;border-bottom:3px solid transparent}
.tab.active{color:#3b82f6;border-bottom-color:#3b82f6}
.table-container{background:#0f172a;border:1px solid #334155;border-radius:12px;overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{background:#1e293b;padding:1rem;text-align:left;color:#3b82f6;font-weight:700;border-bottom:2px solid #3b82f6}
td{padding:1rem;border-bottom:1px solid #334155;color:#cbd5e1}
tr:hover{background:rgba(59,130,246,0.05)}
.badge{padding:0.4rem 0.8rem;border-radius:6px;font-size:0.85rem;font-weight:700;display:inline-block}
.badge-success{background:rgba(16,185,129,0.2);color:#10b981;border:1px solid #10b981}
.badge-warning{background:rgba(245,158,11,0.2);color:#f59e0b;border:1px solid #f59e0b}
.badge-danger{background:rgba(239,68,68,0.2);color:#ef4444;border:1px solid #ef4444}
.alert{padding:1rem;border-radius:8px;margin-bottom:1rem;border-left:4px solid}
.alert-info{background:rgba(59,130,246,0.1);border-color:#3b82f6;color:#60a5fa}
.alert-success{background:rgba(16,185,129,0.1);border-color:#10b981;color:#34d399}
.alert-danger{background:rgba(239,68,68,0.1);border-color:#ef4444;color:#f87171}
.debug{background:#1e293b;border:1px solid #f59e0b;border-radius:8px;padding:1rem;margin-top:1rem;font-family:monospace;font-size:0.85rem;max-height:200px;overflow-y:auto}
.debug-title{color:#f59e0b;font-weight:700;margin-bottom:0.5rem}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üèõÔ∏è DHCM AR RECONCILIATION SYSTEM</h1>
    <p style="color:#94a3b8">Enterprise-Grade Financial Reconciliation with Multi-Pass Matching</p>
  </div>

  <section class="section">
    <h2 class="section-title">üì§ Step 1: Upload Files</h2>
    
    <div class="upload-grid">
      <div class="upload-box" id="ar-upload-box">
        <input type="file" id="ar-file" accept=".xlsx,.xls,.csv" class="file-input">
        <label for="ar-file" class="upload-label">
          <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <div class="upload-title">AR Aging File</div>
          <p style="color:#94a3b8;font-size:0.9rem">Oracle AR Open Items</p>
          <span class="file-name" id="ar-file-name"></span>
        </label>
        <div class="preview" id="ar-preview"></div>
      </div>

      <div class="upload-box" id="bank-upload-box">
        <input type="file" id="bank-file" accept=".xlsx,.xls,.csv" class="file-input" multiple>
        <label for="bank-file" class="upload-label">
          <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <div class="upload-title">Bank Statement(s)</div>
          <p style="color:#94a3b8;font-size:0.9rem">Up to 20 bank files</p>
          <span class="file-name" id="bank-file-name"></span>
        </label>
        <div class="preview" id="bank-preview"></div>
      </div>
    </div>

    <div style="text-align:center">
      <button class="btn btn-secondary" id="generate-sample">Generate Sample Data</button>
      <button class="btn btn-primary hidden" id="start-reconciliation">Start Reconciliation</button>
    </div>
  </section>

  <section class="section hidden" id="results-section">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem">
      <h2 class="section-title" style="margin:0">üìä Reconciliation Results</h2>
      <button class="btn btn-success" id="export-excel">Export to Excel</button>
    </div>

    <div class="stats-grid" id="stats-grid"></div>

    <div class="tabs">
      <button class="tab active" data-tab="matched">Matched</button>
      <button class="tab" data-tab="review">Needs Review</button>
      <button class="tab" data-tab="unmatched-ar">Unmatched AR</button>
      <button class="tab" data-tab="unmatched-bank">Unmatched Bank</button>
    </div>

    <div class="table-container">
      <table id="results-table">
        <thead id="results-thead"></thead>
        <tbody id="results-tbody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
console.log('üöÄ DHCM Reconciliation System Initialized');

const STATE={arData:[],bankData:[],matches:[],unmatchedAR:[],unmatchedBank:[],currentTab:'matched'};

// Event Listeners
document.getElementById('ar-file').addEventListener('change',handleARUpload);
document.getElementById('bank-file').addEventListener('change',handleBankUpload);
document.getElementById('generate-sample').addEventListener('click',generateSampleData);
document.getElementById('start-reconciliation').addEventListener('click',startReconciliation);
document.getElementById('export-excel').addEventListener('click',exportToExcel);
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',e=>switchTab(e.target.dataset.tab)));

async function handleARUpload(e){
  const file=e.target.files[0];
  if(!file){console.error('No file selected');return}
  
  console.log('üìÑ AR File selected:',file.name);
  
  try{
    const rawData=await parseExcelFile(file);
    console.log('üìä Raw AR data rows:',rawData.length);
    console.log('üìã First row keys:',Object.keys(rawData[0]||{}));
    console.log('üîç First 3 rows:',rawData.slice(0,3));
    
    STATE.arData=normalizeARData(rawData);
    console.log('‚úÖ Normalized AR items:',STATE.arData.length);
    console.log('üîç First normalized item:',STATE.arData[0]);
    
    document.getElementById('ar-file-name').textContent=file.name;
    document.getElementById('ar-upload-box').classList.add('uploaded');
    showARPreview(STATE.arData.slice(0,5));
    checkReady();
  }catch(err){
    console.error('‚ùå AR Upload Error:',err);
    alert('Error parsing AR file: '+err.message);
  }
}

async function handleBankUpload(e){
  const files=Array.from(e.target.files);
  if(files.length===0){console.error('No files selected');return}
  
  console.log('üìÑ Bank files selected:',files.length);
  
  try{
    let allBankData=[];
    for(const file of files){
      console.log('üìÑ Processing:',file.name);
      const rawData=await parseExcelFile(file);
      console.log('üìä Raw bank rows:',rawData.length);
      console.log('üìã First row keys:',Object.keys(rawData[0]||{}));
      
      const normalized=normalizeBankData(rawData,file.name);
      console.log('‚úÖ Normalized bank items:',normalized.length);
      allBankData=allBankData.concat(normalized);
    }
    
    STATE.bankData=allBankData;
    console.log('‚úÖ Total bank transactions:',STATE.bankData.length);
    console.log('üîç First bank item:',STATE.bankData[0]);
    
    document.getElementById('bank-file-name').textContent=`${files.length} file(s) - ${STATE.bankData.length} transactions`;
    document.getElementById('bank-upload-box').classList.add('uploaded');
    showBankPreview(STATE.bankData.slice(0,5));
    checkReady();
  }catch(err){
    console.error('‚ùå Bank Upload Error:',err);
    alert('Error parsing bank files: '+err.message);
  }
}

function parseExcelFile(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        console.log('üìñ Reading file...');
        const data=new Uint8Array(e.target.result);
        const workbook=XLSX.read(data,{type:'array',cellDates:true,cellNF:true,raw:false});
        console.log('üìö Workbook sheets:',workbook.SheetNames);
        
        const sheetName=workbook.SheetNames[0];
        const worksheet=workbook.Sheets[sheetName];
        
        const jsonData=XLSX.utils.sheet_to_json(worksheet,{
          raw:false,
          defval:'',
          dateNF:'yyyy-mm-dd',
          blankrows:false
        });
        
        console.log('‚úÖ Parsed JSON rows:',jsonData.length);
        resolve(jsonData);
      }catch(err){
        console.error('‚ùå Parse error:',err);
        reject(err);
      }
    };
    reader.onerror=()=>{
      console.error('‚ùå File read error');
      reject(new Error('Failed to read file'));
    };
    reader.readAsArrayBuffer(file);
  });
}

function getFieldValue(row,...possibleKeys){
  for(const key of possibleKeys){
    const value=row[key];
    if(value!==undefined&&value!==null&&value!==''){
      return String(value).trim();
    }
  }
  return '';
}

function normalizeARData(rawData){
  console.log('üîÑ Normalizing AR data...');
  const normalized=[];
  
  for(let i=0;i<rawData.length;i++){
    const row=rawData[i];
    
    // Get Amount Due Remaining
    const amtDueStr=getFieldValue(row,
      'Amount Due Remaining','AmountDueRemaining','amount_due_remaining',
      'AMOUNT_DUE_REMAINING','Amount_Due_Remaining','Amt Due Remaining'
    );
    
    const amtDue=parseFloat(amtDueStr.replace(/[^0-9.-]/g,''))||0;
    
    // Skip if amount <= 0
    if(amtDue<=0){
      console.log(`‚è≠Ô∏è Skipping row ${i+1}: Amount Due = ${amtDue}`);
      continue;
    }
    
    // Get Transaction Number
    const txnNum=getFieldValue(row,
      'Transaction Number','TransactionNumber','transaction_number',
      'TRANSACTION_NUMBER','Transaction_Number','Trx Number','TrxNumber'
    )||`TXN-${i+1}`;
    
    // Get Customer Name
    const customerName=getFieldValue(row,
      'Customer Name','CustomerName','customer_name',
      'CUSTOMER_NAME','Customer_Name','Debtor Name','DebtorName'
    );
    
    // Get Description
    const description=getFieldValue(row,
      'Transaction Description','TransactionDescription','transaction_description',
      'TRANSACTION_DESCRIPTION','Description','DESCRIPTION','Narration'
    );
    
    // Get Dates
    const txnDate=getFieldValue(row,
      'Transaction Date','TransactionDate','transaction_date',
      'TRANSACTION_DATE','Invoice Date','InvoiceDate','Date','DATE'
    );
    
    const dueDate=getFieldValue(row,
      'Due Date','DueDate','due_date','DUE_DATE','Due_Date','Payment Due'
    );
    
    // Get Original Amount
    const origAmtStr=getFieldValue(row,
      'Original Invoice Amount','OriginalInvoiceAmount','original_invoice_amount',
      'ORIGINAL_INVOICE_AMOUNT','Invoice Amount','InvoiceAmount'
    );
    const origAmt=parseFloat(origAmtStr.replace(/[^0-9.-]/g,''))||amtDue;
    
    // Extract entities from description
    const entities=extractEntitiesFromDesc(description);
    
    const item={
      id:`ar-${i}`,
      transactionNumber:txnNum,
      customerName:customerName,
      companyName:getFieldValue(row,'Company Name','CompanyName','company_name'),
      transactionDescription:description,
      transactionDate:txnDate,
      dueDate:dueDate,
      amountDueRemaining:amtDue,
      originalAmount:origAmt,
      extractedEntities:entities
    };
    
    normalized.push(item);
    console.log(`‚úÖ AR ${i+1}: ${txnNum} - ${customerName} - ${amtDue}`);
  }
  
  console.log(`‚úÖ Normalized ${normalized.length} AR items`);
  return normalized;
}

function normalizeBankData(rawData,fileName){
  console.log('üîÑ Normalizing bank data from:',fileName);
  const normalized=[];
  
  for(let i=0;i<rawData.length;i++){
    const row=rawData[i];
    
    // Get Credit Amount
    const creditStr=getFieldValue(row,
      'Credit','credit','CREDIT','Deposit','DEPOSIT','Amount','AMOUNT'
    );
    
    const credit=parseFloat(creditStr.replace(/[^0-9.-]/g,''))||0;
    
    // Skip if credit <= 0
    if(credit<=0){
      console.log(`‚è≠Ô∏è Skipping bank row ${i+1}: Credit = ${credit}`);
      continue;
    }
    
    // Get Narration
    const narration=getFieldValue(row,
      'Narration','narration','NARRATION','Description','description',
      'DESCRIPTION','Details','DETAILS','Particulars'
    );
    
    // Get Transaction Reference
    const txnRef=getFieldValue(row,
      'Transaction Reference','TransactionReference','transaction_reference',
      'TRANSACTION_REFERENCE','Reference','reference','REFERENCE','Ref','REF'
    )||`BANK-${i+1}`;
    
    // Get Date
    const valueDate=getFieldValue(row,
      'Value Date','ValueDate','value_date','VALUE_DATE',
      'Date','date','DATE','Transaction Date','TransactionDate'
    );
    
    // Get Invoice Numbers field
    const invoiceNums=getFieldValue(row,
      'Invoice Numbers','InvoiceNumbers','invoice_numbers',
      'INVOICE_NUMBERS','Invoice Number','InvoiceNumber'
    );
    
    // Parse narration
    const parsed=parseNarration(narration,invoiceNums);
    
    const item={
      id:`bank-${fileName}-${i}`,
      valueDate:valueDate,
      narration:narration,
      transactionReference:txnRef,
      credit:credit,
      currency:getFieldValue(row,'Currency','currency','CURRENCY')||'AED',
      invoiceNumbers:invoiceNums,
      receiptNumber:getFieldValue(row,'Receipt Number','ReceiptNumber','receipt_number'),
      parsedEntities:parsed
    };
    
    normalized.push(item);
    console.log(`‚úÖ Bank ${i+1}: ${txnRef} - ${credit} - ${narration.substring(0,50)}...`);
  }
  
  console.log(`‚úÖ Normalized ${normalized.length} bank items`);
  return normalized;
}

function extractEntitiesFromDesc(desc){
  if(!desc)return{reqNumbers:[],tmCodes:[],keywords:[]};
  
  const reqNumbers=(desc.match(/REQ-\d{7}/gi)||[]).map(r=>r.toUpperCase());
  const tmCodes=(desc.match(/TM\d{3,4}/gi)||[]).map(t=>t.toUpperCase());
  
  const keywords=[];
  const kw=['NOC','TEMPORARY ACCESS','PERMIT','RENEWAL','ENCROACHMENT','SIGNAGE','FIT OUT','FITOUT'];
  const upper=desc.toUpperCase();
  kw.forEach(k=>{if(upper.includes(k))keywords.push(k)});
  
  return{reqNumbers,tmCodes,keywords};
}

function parseNarration(narration,invoiceNums){
  const result={
    transactionNumbers:[],
    invoiceNumbers:[],
    reqNumbers:[],
    tmCodes:[],
    bankRefs:[],
    payerNames:[],
    keywords:[]
  };
  
  if(!narration)return result;
  
  // Transaction numbers (12-18 digits)
  const txnMatches=narration.match(/\b\d{12,18}\b/g);
  if(txnMatches)result.transactionNumbers=[...new Set(txnMatches)];
  
  // Invoice numbers from separate field
  if(invoiceNums){
    const invMatches=invoiceNums.match(/\b\d{12,18}\b/g);
    if(invMatches)result.invoiceNumbers=[...new Set(invMatches)];
  }
  
  // REQ numbers
  const reqMatches=narration.match(/REQ-\d{7}/gi);
  if(reqMatches)result.reqNumbers=[...new Set(reqMatches.map(r=>r.toUpperCase()))];
  
  // TM codes
  const tmMatches=narration.match(/TM\d{3,4}/gi);
  if(tmMatches)result.tmCodes=[...new Set(tmMatches.map(t=>t.toUpperCase()))];
  
  // Bank references
  const ae0=narration.match(/AE0\d{7,}/gi);
  const sdme=narration.match(/SDME\d{9,}/gi);
  const tt=narration.match(/TT\s*REF[:\s]*[\w\d]+/gi);
  result.bankRefs=[...(ae0||[]),...(sdme||[]),...(tt||[])].map(r=>r.toUpperCase());
  
  // Keywords
  const kw=['NOC','TEMPORARY ACCESS','PERMIT','RENEWAL','ENCROACHMENT','SIGNAGE','FIT OUT','FITOUT'];
  const upper=narration.toUpperCase();
  kw.forEach(k=>{if(upper.includes(k))result.keywords.push(k)});
  
  return result;
}

function showARPreview(items){
  if(items.length===0){
    document.getElementById('ar-preview').innerHTML='<p style="color:#f59e0b">No valid AR items found (Amount Due Remaining must be > 0)</p>';
    return;
  }
  
  let html='<h4>‚úÖ Loaded '+STATE.arData.length+' AR Items</h4>';
  items.forEach(item=>{
    html+=`<div class="preview-item">
      <span class="preview-label">Transaction #:</span>
      <span class="preview-value">${item.transactionNumber}</span><br>
      <span class="preview-label">Customer:</span>
      <span class="preview-value">${item.customerName}</span><br>
      <span class="preview-label">Amount Due:</span>
      <span class="preview-value">${item.amountDueRemaining.toFixed(2)} AED</span><br>
      <span class="preview-label">Date:</span>
      <span class="preview-value">${item.transactionDate}</span>
    </div>`;
  });
  
  document.getElementById('ar-preview').innerHTML=html;
}

function showBankPreview(items){
  if(items.length===0){
    document.getElementById('bank-preview').innerHTML='<p style="color:#f59e0b">No valid bank transactions found (Credit must be > 0)</p>';
    return;
  }
  
  let html='<h4>‚úÖ Loaded '+STATE.bankData.length+' Bank Transactions</h4>';
  items.forEach(item=>{
    html+=`<div class="preview-item">
      <span class="preview-label">Reference:</span>
      <span class="preview-value">${item.transactionReference}</span><br>
      <span class="preview-label">Credit:</span>
      <span class="preview-value">${item.credit.toFixed(2)} ${item.currency}</span><br>
      <span class="preview-label">Date:</span>
      <span class="preview-value">${item.valueDate}</span><br>
      <span class="preview-label">Narration:</span>
      <span class="preview-value">${item.narration.substring(0,60)}...</span>
    </div>`;
  });
  
  document.getElementById('bank-preview').innerHTML=html;
}

function checkReady(){
  if(STATE.arData.length>0&&STATE.bankData.length>0){
    document.getElementById('start-reconciliation').classList.remove('hidden');
    console.log('‚úÖ Ready to reconcile!');
  }
}

function generateSampleData(){
  console.log('üé≤ Generating sample data...');
  
  STATE.arData=[
    {id:'ar-1',transactionNumber:'256010013002797',customerName:'ACME Corporation',companyName:'ACME Corp',transactionDescription:'NOC - Temporary Access REQ-1234567',transactionDate:'2024-01-15',dueDate:'2024-02-15',amountDueRemaining:5250.00,originalAmount:5250.00,extractedEntities:{reqNumbers:['REQ-1234567'],tmCodes:[],keywords:['NOC','TEMPORARY ACCESS']}},
    {id:'ar-2',transactionNumber:'266010013000080',customerName:'Global Industries Ltd',companyName:'Global Industries',transactionDescription:'Permit Renewal TM1234',transactionDate:'2024-01-20',dueDate:'2024-02-20',amountDueRemaining:1050.00,originalAmount:1050.00,extractedEntities:{reqNumbers:[],tmCodes:['TM1234'],keywords:['PERMIT','RENEWAL']}},
    {id:'ar-3',transactionNumber:'256010013002800',customerName:'Tech Solutions Inc',companyName:'Tech Solutions',transactionDescription:'Encroachment Fee REQ-7654321',transactionDate:'2024-01-25',dueDate:'2024-02-25',amountDueRemaining:3500.00,originalAmount:3500.00,extractedEntities:{reqNumbers:['REQ-7654321'],tmCodes:[],keywords:['ENCROACHMENT']}},
  ];
  
  STATE.bankData=[
    {id:'bank-1',valueDate:'2024-01-18',narration:'PAYMENT FROM ACME CORPORATION FOR INVOICE 256010013002797 NOC TEMPORARY ACCESS REQ-1234567',transactionReference:'AE0123456789',credit:5250.00,currency:'AED',invoiceNumbers:'256010013002797',parsedEntities:{transactionNumbers:['256010013002797'],invoiceNumbers:['256010013002797'],reqNumbers:['REQ-1234567'],tmCodes:[],bankRefs:['AE0123456789'],payerNames:[],keywords:['NOC','TEMPORARY ACCESS']}},
    {id:'bank-2',valueDate:'2024-01-22',narration:'TXN BY GLOBAL INDUSTRIES LTD TM1234 PERMIT RENEWAL',transactionReference:'SDME987654321',credit:1050.00,currency:'AED',invoiceNumbers:'',parsedEntities:{transactionNumbers:[],invoiceNumbers:[],reqNumbers:[],tmCodes:['TM1234'],bankRefs:['SDME987654321'],payerNames:[],keywords:['PERMIT','RENEWAL']}},
    {id:'bank-3',valueDate:'2024-01-27',narration:'PAYMENT FROM TECH SOLUTIONS INC REQ-7654321 ENCROACHMENT FEE',transactionReference:'TT REF 555',credit:3500.00,currency:'AED',invoiceNumbers:'',parsedEntities:{transactionNumbers:[],invoiceNumbers:[],reqNumbers:['REQ-7654321'],tmCodes:[],bankRefs:['TT REF 555'],payerNames:[],keywords:['ENCROACHMENT']}},
  ];
  
  document.getElementById('ar-file-name').textContent='Sample_AR_Aging.xlsx';
  document.getElementById('ar-upload-box').classList.add('uploaded');
  showARPreview(STATE.arData);
  
  document.getElementById('bank-file-name').textContent='Sample_Bank_Statement.xlsx';
  document.getElementById('bank-upload-box').classList.add('uploaded');
  showBankPreview(STATE.bankData);
  
  checkReady();
  console.log('‚úÖ Sample data generated');
}

function startReconciliation(){
  console.log('üöÄ Starting reconciliation...');
  console.log('AR Items:',STATE.arData.length);
  console.log('Bank Transactions:',STATE.bankData.length);
  
  // Run matching passes
  const passAMatches=runPassA();
  const passBMatches=runPassB();
  const passCMatches=runPassC();
  
  STATE.matches=[...passAMatches,...passBMatches,...passCMatches];
  
  const matchedARIds=new Set(STATE.matches.map(m=>m.arItemId));
  const matchedBankIds=new Set(STATE.matches.map(m=>m.bankTransactionId));
  
  STATE.unmatchedAR=STATE.arData.filter(ar=>!matchedARIds.has(ar.id));
  STATE.unmatchedBank=STATE.bankData.filter(bank=>!matchedBankIds.has(bank.id));
  
  console.log('‚úÖ Reconciliation complete');
  console.log('Matches:',STATE.matches.length);
  console.log('Unmatched AR:',STATE.unmatchedAR.length);
  console.log('Unmatched Bank:',STATE.unmatchedBank.length);
  
  displayResults();
}

function runPassA(){
  console.log('üîç Pass A: Strong Identifier Match');
  const matches=[];
  const matchedBankIds=new Set();
  
  for(const ar of STATE.arData){
    for(const bank of STATE.bankData){
      if(matchedBankIds.has(bank.id))continue;
      
      const txnNum=ar.transactionNumber;
      const foundInNarration=bank.narration.toUpperCase().includes(txnNum.toUpperCase());
      const foundInInvoiceNums=bank.invoiceNumbers&&bank.invoiceNumbers.includes(txnNum);
      const foundInParsed=bank.parsedEntities.transactionNumbers.includes(txnNum)||bank.parsedEntities.invoiceNumbers.includes(txnNum);
      
      if(foundInNarration||foundInInvoiceNums||foundInParsed){
        const score=95;
        matches.push({
          id:`match-${matches.length}`,
          arItemId:ar.id,
          bankTransactionId:bank.id,
          matchMethod:'PASS_A',
          confidenceScore:score,
          allocatedAmount:Math.min(ar.amountDueRemaining,bank.credit),
          explanation:`Transaction Number "${txnNum}" found in ${foundInNarration?'narration':foundInInvoiceNums?'invoice field':'parsed data'}`,
          status:'AUTO_MATCHED'
        });
        matchedBankIds.add(bank.id);
        console.log(`‚úÖ Match: ${ar.transactionNumber} ‚Üî ${bank.transactionReference}`);
        break;
      }
    }
  }
  
  console.log(`Pass A: ${matches.length} matches`);
  return matches;
}

function runPassB(){
  console.log('üîç Pass B: Structured Reference Match');
  const matches=[];
  const matchedARIds=new Set(STATE.matches.map(m=>m.arItemId));
  const matchedBankIds=new Set(STATE.matches.map(m=>m.bankTransactionId));
  
  for(const ar of STATE.arData){
    if(matchedARIds.has(ar.id))continue;
    
    for(const bank of STATE.bankData){
      if(matchedBankIds.has(bank.id))continue;
      
      const reqMatch=ar.extractedEntities.reqNumbers.some(req=>bank.parsedEntities.reqNumbers.includes(req));
      const tmMatch=ar.extractedEntities.tmCodes.some(tm=>bank.parsedEntities.tmCodes.includes(tm));
      
      if(reqMatch||tmMatch){
        const score=88;
        matches.push({
          id:`match-${STATE.matches.length+matches.length}`,
          arItemId:ar.id,
          bankTransactionId:bank.id,
          matchMethod:'PASS_B',
          confidenceScore:score,
          allocatedAmount:Math.min(ar.amountDueRemaining,bank.credit),
          explanation:`${reqMatch?'REQ number':'TM code'} matched`,
          status:'NEEDS_REVIEW'
        });
        matchedBankIds.add(bank.id);
        console.log(`‚úÖ Match: ${ar.transactionNumber} ‚Üî ${bank.transactionReference} (REF)`);
        break;
      }
    }
  }
  
  console.log(`Pass B: ${matches.length} matches`);
  return matches;
}

function runPassC(){
  console.log('üîç Pass C: Controlled Fuzzy Match');
  const matches=[];
  const matchedARIds=new Set(STATE.matches.map(m=>m.arItemId));
  const matchedBankIds=new Set(STATE.matches.map(m=>m.bankTransactionId));
  
  for(const ar of STATE.arData){
    if(matchedARIds.has(ar.id))continue;
    
    for(const bank of STATE.bankData){
      if(matchedBankIds.has(bank.id))continue;
      
      const amtDiff=Math.abs(ar.amountDueRemaining-bank.credit);
      const amtOk=amtDiff<=0.50||amtDiff/ar.amountDueRemaining<=0.001;
      
      if(!amtOk)continue;
      
      const keywordMatch=ar.extractedEntities.keywords.some(k=>bank.parsedEntities.keywords.includes(k));
      
      if(keywordMatch){
        const score=75;
        matches.push({
          id:`match-${STATE.matches.length+matches.length}`,
          arItemId:ar.id,
          bankTransactionId:bank.id,
          matchMethod:'PASS_C',
          confidenceScore:score,
          allocatedAmount:Math.min(ar.amountDueRemaining,bank.credit),
          explanation:`Keyword match + amount within tolerance`,
          status:'NEEDS_REVIEW'
        });
        matchedBankIds.add(bank.id);
        console.log(`‚úÖ Match: ${ar.transactionNumber} ‚Üî ${bank.transactionReference} (FUZZY)`);
        break;
      }
    }
  }
  
  console.log(`Pass C: ${matches.length} matches`);
  return matches;
}

function displayResults(){
  document.getElementById('results-section').classList.remove('hidden');
  
  const matched=STATE.matches.filter(m=>m.status==='AUTO_MATCHED');
  const review=STATE.matches.filter(m=>m.status==='NEEDS_REVIEW');
  
  const totalAR=STATE.arData.reduce((s,ar)=>s+ar.amountDueRemaining,0);
  const matchedAmt=matched.reduce((s,m)=>s+m.allocatedAmount,0);
  
  document.getElementById('stats-grid').innerHTML=`
    <div class="stat-card">
      <div class="stat-value">${STATE.arData.length}</div>
      <div class="stat-label">Total AR Items</div>
      <div style="color:#94a3b8;font-size:0.85rem;margin-top:0.5rem">${totalAR.toFixed(2)} AED</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${matched.length}</div>
      <div class="stat-label">Auto-Matched</div>
      <div style="color:#10b981;font-size:0.85rem;margin-top:0.5rem">${matchedAmt.toFixed(2)} AED</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${review.length}</div>
      <div class="stat-label">Needs Review</div>
      <div style="color:#f59e0b;font-size:0.85rem;margin-top:0.5rem">70-89% confidence</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${STATE.unmatchedAR.length+STATE.unmatchedBank.length}</div>
      <div class="stat-label">Unmatched</div>
      <div style="color:#ef4444;font-size:0.85rem;margin-top:0.5rem">${STATE.unmatchedAR.length} AR, ${STATE.unmatchedBank.length} Bank</div>
    </div>
  `;
  
  switchTab('matched');
}

function switchTab(tab){
  STATE.currentTab=tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
  
  if(tab==='matched'){
    const data=STATE.matches.filter(m=>m.status==='AUTO_MATCHED');
    renderMatchTable(data);
  }else if(tab==='review'){
    const data=STATE.matches.filter(m=>m.status==='NEEDS_REVIEW');
    renderMatchTable(data);
  }else if(tab==='unmatched-ar'){
    renderUnmatchedARTable();
  }else if(tab==='unmatched-bank'){
    renderUnmatchedBankTable();
  }
}

function renderMatchTable(data){
  const thead='<tr><th>AR Transaction #</th><th>Bank Reference</th><th>Customer</th><th>Amount</th><th>Method</th><th>Score</th><th>Explanation</th></tr>';
  const tbody=data.map(m=>{
    const ar=STATE.arData.find(a=>a.id===m.arItemId);
    const bank=STATE.bankData.find(b=>b.id===m.bankTransactionId);
    const badgeClass=m.status==='AUTO_MATCHED'?'badge-success':'badge-warning';
    return`<tr>
      <td><strong>${ar.transactionNumber}</strong></td>
      <td>${bank.transactionReference}</td>
      <td>${ar.customerName}</td>
      <td><strong>${m.allocatedAmount.toFixed(2)} AED</strong></td>
      <td><span class="badge ${badgeClass}">${m.matchMethod}</span></td>
      <td><strong style="color:#10b981">${m.confidenceScore}%</strong></td>
      <td>${m.explanation}</td>
    </tr>`;
  }).join('');
  
  document.getElementById('results-thead').innerHTML=thead;
  document.getElementById('results-tbody').innerHTML=tbody||'<tr><td colspan="7" style="text-align:center;padding:2rem;color:#94a3b8">No data</td></tr>';
}

function renderUnmatchedARTable(){
  const thead='<tr><th>Transaction #</th><th>Customer</th><th>Amount Due</th><th>Date</th><th>Description</th></tr>';
  const tbody=STATE.unmatchedAR.map(ar=>`<tr>
    <td><strong>${ar.transactionNumber}</strong></td>
    <td>${ar.customerName}</td>
    <td><strong>${ar.amountDueRemaining.toFixed(2)} AED</strong></td>
    <td>${ar.transactionDate}</td>
    <td>${ar.transactionDescription.substring(0,60)}...</td>
  </tr>`).join('');
  
  document.getElementById('results-thead').innerHTML=thead;
  document.getElementById('results-tbody').innerHTML=tbody||'<tr><td colspan="5" style="text-align:center;padding:2rem;color:#10b981">All AR items matched!</td></tr>';
}

function renderUnmatchedBankTable(){
  const thead='<tr><th>Reference</th><th>Narration</th><th>Credit</th><th>Date</th></tr>';
  const tbody=STATE.unmatchedBank.map(b=>`<tr>
    <td>${b.transactionReference}</td>
    <td>${b.narration.substring(0,80)}...</td>
    <td><strong>${b.credit.toFixed(2)} ${b.currency}</strong></td>
    <td>${b.valueDate}</td>
  </tr>`).join('');
  
  document.getElementById('results-thead').innerHTML=thead;
  document.getElementById('results-tbody').innerHTML=tbody||'<tr><td colspan="4" style="text-align:center;padding:2rem;color:#10b981">All bank transactions matched!</td></tr>';
}

function exportToExcel(){
  console.log('üì• Exporting to Excel...');
  
  const wb=XLSX.utils.book_new();
  
  const matched=STATE.matches.filter(m=>m.status==='AUTO_MATCHED');
  const review=STATE.matches.filter(m=>m.status==='NEEDS_REVIEW');
  
  const matchedData=matched.map(m=>{
    const ar=STATE.arData.find(a=>a.id===m.arItemId);
    const bank=STATE.bankData.find(b=>b.id===m.bankTransactionId);
    return{
      'AR Transaction Number':ar.transactionNumber,
      'Bank Reference':bank.transactionReference,
      'Customer Name':ar.customerName,
      'Allocated Amount':m.allocatedAmount,
      'Bank Date':bank.valueDate,
      'Invoice Date':ar.transactionDate,
      'Match Method':m.matchMethod,
      'Confidence Score':m.confidenceScore+'%',
      'Explanation':m.explanation
    };
  });
  
  const reviewData=review.map(m=>{
    const ar=STATE.arData.find(a=>a.id===m.arItemId);
    const bank=STATE.bankData.find(b=>b.id===m.bankTransactionId);
    return{
      'AR Transaction Number':ar.transactionNumber,
      'Bank Reference':bank.transactionReference,
      'Customer Name':ar.customerName,
      'Allocated Amount':m.allocatedAmount,
      'Bank Date':bank.valueDate,
      'Invoice Date':ar.transactionDate,
      'Match Method':m.matchMethod,
      'Confidence Score':m.confidenceScore+'%',
      'Explanation':m.explanation
    };
  });
  
  const unmatchedARData=STATE.unmatchedAR.map(ar=>({
    'Transaction Number':ar.transactionNumber,
    'Customer Name':ar.customerName,
    'Amount Due Remaining':ar.amountDueRemaining,
    'Transaction Date':ar.transactionDate,
    'Due Date':ar.dueDate,
    'Description':ar.transactionDescription
  }));
  
  const unmatchedBankData=STATE.unmatchedBank.map(b=>({
    'Bank Reference':b.transactionReference,
    'Narration':b.narration,
    'Credit':b.credit,
    'Date':b.valueDate,
    'Currency':b.currency
  }));
  
  const summary=[
    ['DHCM AR RECONCILIATION REPORT'],
    ['Generated:',new Date().toLocaleString()],
    [''],
    ['SUMMARY'],
    ['Total AR Items',STATE.arData.length],
    ['Total Bank Transactions',STATE.bankData.length],
    ['Auto-Matched',matched.length],
    ['Needs Review',review.length],
    ['Unmatched AR',STATE.unmatchedAR.length],
    ['Unmatched Bank',STATE.unmatchedBank.length]
  ];
  
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(summary),'Summary');
  if(matchedData.length>0)XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(matchedData),'Matched');
  if(reviewData.length>0)XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(reviewData),'Needs Review');
  if(unmatchedARData.length>0)XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(unmatchedARData),'Unmatched AR');
  if(unmatchedBankData.length>0)XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(unmatchedBankData),'Unmatched Bank');
  
  XLSX.writeFile(wb,`DHCM_Reconciliation_${new Date().toISOString().split('T')[0]}.xlsx`);
  console.log('‚úÖ Excel exported');
}

console.log('‚úÖ System ready');
</script>
</body>
</html>